#!/usr/bin/env php
<?php
require_once __DIR__ . '/../vendor/autoload.php';
$doc = <<<DOC
Usage: bin/SWBT (run | start | stop | status | status-job | list-tubes)

Options:
  -h --help    help info
  -b --bootstrap  the bootstrap file path

DOC;
$args = Docopt::handle($doc,['version'=>'0.0.1']);
$bootStrapFilePath = __DIR__ . '/../bootstrap/SWBT.php';
$container = require $bootStrapFilePath;
if (!$container instanceof \Pimple\Container){
    die('SWBT is not instance of Pimple\Container');
}
if ($args->args['run']){
    $SWBT = new SWBT\SWBT($container, false);
    $SWBT->run();
} elseif ($args->args['start']){
    $SWBT = new SWBT\SWBT($container, true);
    $SWBT->run();
} elseif ($args->args['stop']){
    $pid = file_get_contents($container['root_dir'] . 'storage/master.pid');
    if (empty($pid)){
        $container['logger']->error('storage/master.pid Null');
    } else {
        exec("kill -9 $pid");
        $container['logger']->info('Stoped', ['pid' => $pid]);
        file_put_contents($container['root_dir'] . 'storage/master.pid', '');
    }
}
if ($args->args['status']){
    $Queue = new \SWBT\Queue($container);
    $Queue->status();
}
if ($args->args['status-job']){
    $Queue = new \SWBT\Queue($container);
    $Queue->status('current-jobs');
}
if ($args->args['list-tubes']){
    $Queue = new \SWBT\Queue($container);
    $Queue->listTubes();
}

